/**
 * SdAgent 1.3.6
 * 
 * Copyright (c) 2012-2015 www.sandi.com.cn. All rights reserved.
 *
 * 2016.1.21 add sendDTMF method
 */
(function($,undefined){var instances={},agents={},transports={},objxdr=null,throbber=$.browser.webkit&&!$.isReady;if(throbber){$(window).load(function(){throbber=false})}$.stream=function(url,options){if(!arguments.length){for(var i in instances){return instances[i]}return null}var instance=instances[url];if(!options){return instance||null}else{if(instance&&instance.readyState<3){return instance}}var stream={url:url,options:$.stream.setup({},options),readyState:0,send:function(){},close:function(){}},match=/^(http|ws)s?:/.exec(stream.url),open=function(){agents[stream.options.type](stream)};if(match){stream.options.type=match[1]}for(var i in {open:1,message:1,error:1,close:1}){stream.options[i]=$.makeArray(stream.options[i])}instances[stream.url]=stream;if(stream.options.alias){instances[stream.options.alias]=stream}if(stream.options.type==="ws"||!throbber){open()}else{switch(stream.options.throbber.type||stream.options.throbber){case"lazy":$(window).load(function(){setTimeout(open,stream.options.throbber.delay||50)});break;case"reconnect":open();$(window).load(function(){if(stream.readyState===0){stream.options.open.push(function(){stream.options.open.pop();setTimeout(reconnect,10)})}else{reconnect()}function reconnect(){stream.options.close.push(function(){stream.options.close.pop();setTimeout(function(){$.stream(stream.url,stream.options)},stream.options.throbber.delay||50)});var reconn=stream.options.reconnect;stream.close();stream.options.reconnect=reconn}});break}}return stream};$.extend($.stream,{version:"1.2",setup:function(target,options){if(!options){options=target;target=$.extend(true,$.stream.options,options)}else{$.extend(true,target,$.stream.options,options)}for(var field in {context:1,url:1}){if(field in options){target[field]=options[field]}else{if(field in $.stream.options){target[field]=$.stream.options[field]}}}return target},options:{type:window.WebSocket?"ws":"http",reconnect:true,global:true,throbber:"lazy",dataType:"text",closeFlag:0,converters:{text:window.String,json:$.parseJSON,xml:$.parseXML}}});
$.extend(agents,{ws:function(stream){if(!window.WebSocket){return}var url=prepareURL(getAbsoluteURL(stream.url).replace(/^http/,"ws"),stream.options.openData),ws=stream.options.protocols?new window.WebSocket(url,stream.options.protocols):new window.WebSocket(url);$.extend(ws,{onopen:function(event){stream.readyState=1;trigger(stream,event)},onmessage:function(event){trigger(stream,$.extend({},event,{data:stream.options.converters[stream.options.dataType](event.data)}))},onerror:function(event){stream.options.reconnect=false;trigger(stream,event)},onclose:function(event){var readyState=stream.readyState;stream.readyState=3;trigger(stream,event);if(stream.options.reconnect&&readyState!==0){$.stream(stream.url,stream.options)}}});$.extend(stream,{send:function(data){if(stream.readyState===0){$.error("INVALID_STATE_ERR: Stream not open")}ws.send(typeof data==="string"?data:param(data))},close:function(){if(stream.readyState<2){stream.readyState=2;stream.options.reconnect=false;ws.close()}}})},http:function(stream){var transportFn,transport,handleOpen,handleMessage,handleSend,sending,dataQueue=[],message={index:0,data:""};transportFn=transports[stream.options.enableXDR&&window.XDomainRequest?"xdr":window.ActiveXObject?"iframe":window.XMLHttpRequest?"xhr":null];if(!transportFn){return}handleOpen=stream.options.handleOpen||function(text,message,stream){stream.id=text.substring(0,text.indexOf(";"));message.index=text.indexOf(";",stream.id.length+1)+1};handleMessage=stream.options.handleMessage||function(text,message){if(message.size==null){var sizeEnd=text.indexOf(";",message.index);if(sizeEnd<0){return false}message.size=+text.substring(message.index,sizeEnd);message.index=sizeEnd+1}var data=text.substr(message.index,message.size-message.data.length);message.data+=data;message.index+=data.length;if(message.size!==message.data.length){return false}var dataEnd=text.indexOf(";",message.index);if(dataEnd<0){return false}message.index=dataEnd+1;delete message.size};handleSend=stream.options.handleSend||function(type,options,stream){var metadata={"metadata.id":stream.id,"metadata.type":type};
options.data=type==="close"?param(metadata):((typeof options.data==="string"?options.data:param(options.data))+"&"+param(metadata))};transport=transportFn(stream,{response:function(text){if(stream.readyState===0){if(handleOpen(text,message,stream)===false){return}stream.readyState=1;trigger(stream,"open")}for(;;){if(handleMessage(text,message,stream)===false){return}if(stream.readyState<3){trigger(stream,"message",{data:stream.options.converters[stream.options.dataType](message.data),origin:"",lastEventId:"",source:null,ports:null})}message.data=""}},close:function(isError){var readyState=stream.readyState;stream.readyState=3;if(isError){stream.options.reconnect=false;if(readyState===0){trigger(stream,"close",{wasClean:false,code:null,reason:""})}else{trigger(stream,"error")}}else{trigger(stream,"close",{wasClean:true,code:null,reason:""});if(stream.options.reconnect){$.stream(stream.url,stream.options)}}}},message);transport.open();$.extend(stream,{send:function(data){if(stream.readyState===0){$.error("INVALID_STATE_ERR: Stream not open")}dataQueue.push(data);if(!sending){sending=true;(function post(){if(stream.readyState===1&&dataQueue.length){var options={url:stream.url,type:"POST",data:dataQueue.shift()};var tmpData=options.data;if(handleSend("send",options,stream)!==false){if(stream.options.enableXDR&&window.XDomainRequest){data.xdr="xdr";transport.extendOpen(tmpData,post)}else{$.ajax(options).complete(post)}}else{post()}}else{sending=false}})()}},close:function(){if(stream.readyState<2){stream.readyState=2;var options={url:stream.url,type:"POST"};if(handleSend("close",options,stream)!==false){if(stream.options.enableXDR&&window.XDomainRequest){transport.extendOpen({"xdr":"xdr"},function(){})}else{$.ajax(options)}}stream.options.reconnect=false;transport.close()}}})}});$.extend(transports,{xhr:function(stream,handler,message){var stop,polling,preStatus,xhr=new window.XMLHttpRequest();xhr.onreadystatechange=function(){switch(xhr.readyState){case 3:if(xhr.status!==200){return
}handler.response(xhr.responseText);if($.browser.opera&&!polling){polling=true;stop=iterate(function(){if(xhr.readyState===4){return false}if(xhr.responseText.length>message.index){handler.response(xhr.responseText)}},stream.options.operaInterval)}break;case 4:handler.close(xhr.status!==200&&preStatus!==200);break}};return{open:function(){xhr.open("GET",prepareURL(stream.url,stream.options.openData));xhr.send()},close:function(){if(stop){stop()}try{preStatus=xhr.status}catch(e){}xhr.abort()}}},iframe:function(stream,handler,message){var stop,closed,onload=function(){if(!closed){closed=true;handler.close()}},doc=new window.ActiveXObject("htmlfile");doc.open();doc.close();return{open:function(){var iframe=doc.createElement("iframe");iframe.src=prepareURL(stream.url,stream.options.openData);doc.body.appendChild(iframe);var cdoc=iframe.contentDocument||iframe.contentWindow.document;stop=iterate(function(){if(!cdoc.documentElement){return}if(cdoc.readyState==="complete"){try{$.noop(cdoc.fileSize)}catch(e){handler.close(true);return false}}var response=cdoc.body.lastChild,readResponse=function(){var clone=response.cloneNode(true);clone.appendChild(cdoc.createTextNode("."));var text=clone.innerText;return text.substring(0,text.length-1)};if(!$.nodeName(response,"pre")){var head=cdoc.head||cdoc.getElementsByTagName("head")[0]||cdoc.documentElement,script=cdoc.createElement("script");script.text="document.write('<plaintext>')";head.insertBefore(script,head.firstChild);head.removeChild(script);response=cdoc.body.lastChild}handler.response(readResponse());stop=iterate(function(){var text=readResponse();if(text.length>message.index){handler.response(text);response.innerText="";message.index=0}if(cdoc.readyState==="complete"){onload();return false}},stream.options.iframeInterval);return false})},close:function(){if(stop){stop()}doc.execCommand("Stop");onload()}}},xdr:function(stream,handler){var xdr=new window.XDomainRequest(),rewriteURL=stream.options.rewriteURL||function(url){var rewriters={JSESSIONID:function(sid){return url.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+sid+"$1")
},PHPSESSID:function(sid){return url.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+sid+"&").replace(/&$/,"")}};for(var name in rewriters){var matcher=new RegExp("(?:^|;\\s*)"+encodeURIComponent(name)+"=([^;]*)").exec(document.cookie);if(matcher){return rewriters[name](matcher[1])}}return url};xdr.onprogress=function(){handler.response(xdr.responseText)};xdr.onerror=function(){handler.close(true)};var onload=xdr.onload=function(){handler.close()};return{open:function(){xdr.open("GET",prepareURL(rewriteURL(stream.url),stream.options.openData));xdr.send()},close:function(){xdr.abort();onload()},extendOpen:function(data,post){if($.browser.version!="8.0"||stream.options.closeFlag==0){objxdr=new XDomainRequest();objxdr.onload=post;objxdr.open("GET",prepareURL(stream.url,data));objxdr.send()}else{xdr.onload=post;try{xdr.open("GET",prepareURL(stream.url,data))}catch(e){}try{xdr.send()}catch(e){}}}}}});$(window).bind("unload.stream",function(){for(var url in instances){instances[url].close();delete instances[url]}});$.each("streamOpen streamMessage streamError streamClose".split(" "),function(i,o){$.fn[o]=function(f){return this.bind(o,f)}});function getAbsoluteURL(url){var div=document.createElement("div");div.innerHTML="<a href='"+url+"'/>";return div.firstChild.href}function trigger(stream,event,props){event=event.type?event:$.extend($.Event(event),{bubbles:false,cancelable:false},props);var handlers=stream.options[event.type],applyArgs=[event,stream];for(var i=0,length=handlers.length;i<length;i++){handlers[i].apply(stream.options.context,applyArgs)}if(stream.options.global){$.event.trigger("stream"+event.type.substring(0,1).toUpperCase()+event.type.substring(1),applyArgs)}}function prepareURL(url,data){if(data&&typeof data!=="string"){data=param(data)}var ts=$.now(),ret=url.replace(/([?&])_=[^&]*/,"$1_="+ts);return ret+(ret===url?(/\?/.test(url)?"&":"?")+"_="+ts:"")+(data?("&"+data):"")}function param(data){return $.param(data,$.ajaxSettings.traditional)}function iterate(fn,interval){var timeoutId;
interval=interval||0;(function loop(){timeoutId=setTimeout(function(){if(fn()===false){return}loop()},interval)})();return function(){clearTimeout(timeoutId)}}})(jQuery);
var SdAgent={topics:{},reconnect:false,url:"",userCode:"",userPwd:"",agtId:"",lastRunCmdTm:0,ctiId:"",verifyCode:""};SdAgent.run=function(cmd){$.stream().send({"Act":cmd,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode})};SdAgent.event=function(id){var callbacks,topic=id&&this.topics[id];if(!topic){callbacks=jQuery.Callbacks();topic={publish:callbacks.fire,subscribe:callbacks.add,unsubscribe:callbacks.remove};if(id){this.topics[id]=topic}}return topic};SdAgent.execConnect=function(url,userCode,userPwd,force,closeFlag){if($.stream()!=null){$($.stream()).empty()}$.stream.setup({enableXDR:true});if(url.substr(-1)!="/"){url=url+"/"}SdAgent.reconnect=force=="1"?true:false;SdAgent.url=url;SdAgent.userCode=userCode;SdAgent.userPwd=userPwd;$.stream(url+"SandiAgent?ForceConnect="+force+"&UserCode="+userCode+"&UserPwd="+userPwd,{type:"http",dataType:"json",reconnect:false,closeFlag:closeFlag,open:function(event,stream){if(stream.id==""){return}var strArr=stream.id.split("-");if(strArr.length>1){SdAgent.ctiId=strArr[0];SdAgent.agtId=strArr[1];if(strArr.length>2){SdAgent.verifyCode=strArr[2]}}else{SdAgent.agtId=stream.id}SdAgent.run("connect")},message:function(event){writeLog("消息回调");if(event.data==null){writeLog("回调消息为空");return}writeLog("消息回调命令："+event.data.CMD);SdAgent.agtEvt(event.data.CMD,event.data.DATA)},error:function(){},close:function(event){if(SdAgent.reconnect==true){SdAgent.reconnect=false;setTimeout(function(){SdAgent.connect(SdAgent.url,SdAgent.userCode,SdAgent.userPwd,"0")},300)}}})};SdAgent.connect=function(url,userCode,userPwd,force){if($.browser.msie){if($.browser.version=="8.0"){var objxdr=new XDomainRequest();objxdr.onload=function(){SdAgent.execConnect(url,userCode,userPwd,force,objxdr.responseText)};var d=new Date();if(url.substr(-1)!="/"){url=url+"/"}objxdr.open("GET",url+"CheckConnectServlet?UserCode="+userCode+"&UserPwd="+userPwd+"&jsid="+d.getTime());objxdr.send();return}}SdAgent.execConnect(url,userCode,userPwd,force,0)};SdAgent.disconnect=function(){this.run("disconnect")};SdAgent.alive=function(){this.run("Alive")
};SdAgent.logon=function(groupid,station){var data={"Act":"logon","AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};if(groupid!=undefined&&groupid!=""){data.groups=groupid}if(station!=undefined&&station!=""){data.station=station}$.stream().send(data)};SdAgent.logout=function(){this.run("logout")};SdAgent.pause=function(){this.run("pause")};SdAgent.restore=function(){this.run("restore")};SdAgent.offHook=function(){this.run("offHook")};SdAgent.onHook=function(){this.run("onHook")};SdAgent.agtWorkAfterCall=function(){this.run("agtWorkAfterCall")};SdAgent.agtWorkAfterCallOver=function(){this.run("agtWorkAfterCallOver")};SdAgent.agtHold=function(){this.run("agtHold")};SdAgent.agtRetrieve=function(){this.run("agtRetrieve")};SdAgent.dialout=function(dnis,type,grpId){var data={"Act":"dial","dnis":dnis,"dialType":type,"grpId":grpId,"extDnis":dnis,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.dialTrans=function(){this.run("dialTrans")};SdAgent.talkingDialJoin=function(){this.run("talkingDialJoin")};SdAgent.agtGetAgtInfo=function(agentid){var data={"Act":"agtGetAgtInfo","destAgt":agentid,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.getAllAgtInfo=function(orgIds){if(orgIds==null||orgIds==undefined||$.trim(orgIds)==""){this.run("getAllAgtInfo")}else{var data={"Act":"getAllAgtInfo","orgIds":orgIds,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)}};SdAgent.dialTransIVR=function(callid,agentid,grpid,ivrstr){var data={"Act":"agtReturnIVR","ivrRet":1,"callId":callid,"array":agentid+","+grpid+",,,,"+ivrstr,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtReturnIVR=function(ivrRet,callId,ivrList){var data={"Act":"agtReturnIVR","ivrRet":ivrRet,"callId":callId,"array":ivrList,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};
$.stream().send(data)};SdAgent.getOrgTreeJson=function(){this.run("getOrgTreeJson")};SdAgent.logoutAgent=function(agentId){var data={"Act":"logoutAgent","destAgt":agentId,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtListen=function(destAgt){var data={"Act":"agtListen","destAgt":destAgt,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtUnListen=function(){this.run("agtUnListen")};SdAgent.agtDisconnectCall=function(destAgt,callId){var data={"Act":"agtDisconnectCall","destAgt":destAgt,"callId":callId,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtIntercept=function(destAgt,callId){var data={"Act":"agtIntercept","destAgt":destAgt,"callId":callId,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtJoinTalk=function(destAgt,callId){var data={"Act":"agtJoinTalk","destAgt":destAgt,"callId":callId,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtExitTalk=function(){this.run("agtExitTalk")};SdAgent.talkingDialJoin=function(){this.run("talkingDialJoin")};SdAgent.agtReqAgtCallAct=function(destAgt,actType,content){var data={"Act":"agtReqAgtCallAct","destAgt":destAgt,"actType":actType,"content":content,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.acceptAgtReq=function(destAgt){var data={"Act":"acceptAgtReq","destAgt":destAgt,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.getOrgAgtgrps=function(orgIds){if(orgIds==null||orgIds==undefined||$.trim(orgIds)==""){this.run("getOrgAgtgrps")}else{var data={"Act":"getOrgAgtgrps","orgIds":orgIds,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)}};SdAgent.getAgentRights=function(){this.run("getAgentRights")
};SdAgent.getAgtGroups=function(){this.run("getAgtGroups")};SdAgent.sendDTMF=function(dtmf){var data={"Act":"sendDTMF","dtmf":dtmf,"AgentId":SdAgent.agtId,"CTIID":SdAgent.ctiId,"VerifyCode":SdAgent.verifyCode};$.stream().send(data)};SdAgent.agtEvt=function(cmd,data){var json;if(data!=null&&data!=""&&data!=undefined){if(typeof(data)=="object"){json=data}else{try{json=eval("("+data+")")}catch(e){}}}switch(cmd){case"onConnect":this.event(cmd).publish(json.result,json.description);break;case"onDisconnect":this.event(cmd).publish();break;case"onAgtReqReturn":this.event(cmd).publish(json.cmdItem,json.retCode,json.description);break;case"onAlive":this.event(cmd).publish();break;case"onRing":this.event(cmd).publish(json.callId,json.subId,json.area,json.ani,json.grpId,json.srcAgt,json.ivrList);break;case"onRunAGTINFO":this.event("onRunAgtInfo").publish(json.status,json.hook,json.occupy);break;case"onStopRing":this.event(cmd).publish();break;case"onRingStop":this.event(cmd).publish();break;case"onRunDIAL_DIALED":this.event("onRunDialDialed").publish(json.callId,json.subId,json.area,json.dnis);break;case"onRunDIAL_OVER":this.event("onRunDialOver").publish(json.rlt,json.rltDesc);break;case"onQueueInfo":this.event(cmd).publish(json.grpId,json.waitCall);break;case"onRunTALKINGDIAL_CALLIN":this.event("onRunTalkingDialCallIn").publish(json.callerId,json.callId,json.subId,json.area,json.ani,json.grpId,json.description);break;case"onAgtInfo":this.event(cmd).publish(json.ret,json.agtId,json.info,json.errMsg);break;case"onAgtDetailInfo":this.event(cmd).publish(json.agtId,json.name,json.agtStatus,json.callStatus,json.hook,json.occupy,json.lastCall,json.webServiceUrl);break;case"onAllAgtInfo":this.event(cmd).publish(json.ret,json.errMsg,json.allAgtInfo,json.cnt);break;case"onASConnected":this.event(cmd).publish();break;case"onForceConnect":this.event(cmd).publish();break;case"onRunLOGON":this.event("onAgtReqReturn").publish(4,1,json.description);case"onTreeJsonInfo":this.event(cmd).publish(data);
break;case"onCallerHangup":this.event(cmd).publish(data);break;case"onIntercept":this.event(cmd).publish(json.ret,json.callId,json.subId,json.area,json.ani,json.grpId,json.srcAgt,json.errMsg,json.ivrList);break;case"onIntercepted":this.event(cmd).publish(json.agtId,json.agtName,json.callId);break;case"onCallDisconnected":this.event(cmd).publish(json.agtId,json.agtName);break;case"onReqAgtCallAct":this.event(cmd).publish(json.srcAgtId,json.srcAgtName,json.tmTime,json.actType,json.callId,json.content);break;case"onAcceptAgtReq":this.event(cmd).publish();break;case"onGetOrgAgtgrps":this.event(cmd).publish(json);break;case"onGetAgentRights":this.event(cmd).publish(json);break;case"onGetAgtGroups":this.event(cmd).publish(json);break;default:break}};function callbackTest(data){alert(data)};
